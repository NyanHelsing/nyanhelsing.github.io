export const slug = "cloudwatch-quotes-queries";
export const title = "Fields and Quotation Marks and Filtering in Cloudwatch Queries";
export const date = "2024-03-10T06:32:49.259Z";
export const cover = "cloud-queries.png";
export const tags = [];
export const summary = "Crafting effective CloudWatch Logs Insights queries requires a solid understanding of fields and quotation marks. Let's explore how to include fields in your queries and the nuanced use of quotation marks to evaluate fields on the fly.";
/*****************************************************************************/

# Crafting CloudWatch Queries: A Guide to Fields, Quotation Marks and Filtering

In AWS, Cloudwatch serves as an essential monitoring service. Logs are messages generated by your applications and services, and Cloudwatch Logs Insights allows you to query and analyze these logs. By writing effective CloudWatch Logs Insights queries, valuable insights can be obtained from log data.

While Log Insights isn't a crystal ball granting vision into the future, it can help you understand what's happening in a system, identify issues, and optimize performance.

Crafting a cloudwatch query that targets a specific aspect of log data can serve as evidence of a behaivour and make potential resolutions more actionable, but doing so requires foundational knowledge of how fields and quotation marks work in a Log Insights query.

## Log Groups

When querying log data in CloudWatch Logs Insights, the first step is to identify the log group that contains the log data to be analyzed. There might be lots of applications, services, or resources generating log data, and each of these might log to a different log group.

## Understanding Fields in CloudWatch Queries

Fields are essentially the building blocks of CloudWatch queries. They point to specific pieces of data within your log events, enabling to filtering, sorting, and analysis of logs in a more granular way. When constructing a query, specifying the fields of interest helps narrow down the results and focus on the data that matters most.

### Including Fields in a Query

To include fields in CloudWatch query, start by identifying the log events that contain the data points you're interested in.

Fields can be anything from the default fields that CloudWatch logs automatically provide, like `@timestamp` or `@message`, to custom fields extracted from the log events.

Here's a basic structure of how to include fields in a query:

```plaintext
fields @timestamp, @message, customField1, customField2
| filter @message like /error/
| sort @timestamp desc
| limit 20
```

In this example, we specify that we're interested in the timestamp, the message content, and two custom fields named `customField1` and `customField2`.

## Handling Special Characters in Field Names

In CloudWatch Logs Insights, field names sometimes contain spaces, hyphens, or other special characters that can disrupt the query syntax. To address this challenge, AWS allows the use of backticks (\`) to encapsulate field names, ensuring that they are interpreted correctly by the query engine.

Backticks are essential when your log events include custom fields with names that don't adhere to the standard naming conventions (e.g., containing spaces, hyphens, or starting with a number). Enclosing these field names in backticks tells CloudWatch to treat the entire encapsulated string as a single field name, avoiding syntax errors and ensuring accurate query execution.

### Using Backticks in Your Queries

Here's how to incorporate backticks into your CloudWatch query for fields with special characters:

```plaintext
fields @timestamp, `user-id`, `error-message`
| filter `error-message` like /critical error/
| sort @timestamp desc
| limit 20
```

In this example, we use backticks to include the `user-id` and `error-message` fields in our query, both of which contain a hyphen, a character that could otherwise interrupt the query's syntax. We then proceed to filter, sort, and limit our results as needed.

### Considerations When Using Backticks

- **Consistency:** Always use backticks for field names with special characters throughout your query to maintain consistency and avoid errors.
- **Compatibility:** Remember that backticks are specifically for field names. Ensure that you're not using them for string literals or expressions where they're not required.

## Quotation Marks in CloudWatch Queries

When filtering based on certain values a field has, the simple use of quotation marks can match an exact value a field has. This is useful when you want to filter log events based on specific values of a field.

```plaintext
fields @timestamp, `user-id`, `error-message`
| filter `error-message` = "Critical error: Timeout"
| sort @timestamp desc
| limit 20
```

In this example, we're filtering log events based on the exact value of the `error-message` field, which is "Critical error: Timeout". The quotation marks ensure that the query engine evaluates the expression as a string literal, matching the exact value of the field.

## Parsing Fields on the fly with Glob capture groups

Glob capture groups are a powerful feature that allows you to extract specific parts of a field's value using glob patterns. This is useful when you want to extract specific pieces of information from a field's value and use them in your query.

```plaintext
fields @timestamp, `user-id`, `error-message`
| parse `error-message` "* ERROR: *" as prefix, detailedError
| filter detailedError like /timeout/
| sort @timestamp desc
| limit 20
```

In this example, we're using the `parse` command to extract specific parts of the `error-message` field's value. We're looking for log events where the `error-message` contains the word "ERROR", and then extracting the detailed error message that follows it. We then filter the log events based on the extracted detailed error message, sort the results, and limit the output as needed.

## Filtering and Regular Expressions

In addition to glob patterns, CloudWatch Logs Insights also supports regular expressions for more advanced filtering of log events. Regular expressions are a powerful tool for matching complex patterns within a field's value, allowing for more precise and flexible filtering.

```plaintext
fields @timestamp, `user-id`, `error-message`
| filter `error-message` like /timeout/
| parse @message /(?<errorType>ERROR|WARNING): (?<detailedError>.*)/
| sort @timestamp desc
| limit 20
```

In this example, we're using the `filter` command to match log events where the `error-message` field contains the word "timeout"; we then use the `parse` command to extract specific parts of the `@message` field's value using a regular expression. We're looking for log events where the `@message` contains the words "ERROR" or "WARNING", and then extracting the detailed error message that follows it. We then sort the results and limit the output as needed.

## Advanced Tip: Combining Techniques

Combining the use of backticks with the previously discussed techniques (fields, quotation marks, and concatenation) enables you to construct complex and precise queries, even when dealing with challenging log data structures.

Hereâ€™s an more advanced example that combines these techniques:

```plaintext
fields @timestamp, `user-id`, `operation`, @message
| parse @message "[*] [*] [*] ERROR: * - *" as @timestamp, `user-id`, `operation`, errorCode, detailedError
| filter `operation` like /database/ and (detailedError like /timeout/ or detailedError like /connection failed/)
| sort @timestamp desc
| limit 100
| fields @timestamp, `user-id`, `operation`, errorCode, detailedError, "Error encountered by user " + `user-id` + " during " + `operation` + " at " + @timestamp + ": " + errorCode + " - " + detailedError as comprehensiveError
```
In this example, we're concatenating fields with strings to provide a more detailed error message. Notice how we use the `+` operator for concatenation and quotation marks to include static text parts.

It also handles fields with special characters, extract specific error messages, and concatenate fields with strings to generate a detailed error description, providing a comprehensive view of the error events.

## Conclusion

Mastering CloudWatch Logs Insights queries allows for powerful data extraction and analysis, critical for monitoring and troubleshooting AWS resources. By understanding how to effectively include fields in your queries and using quotation marks to dynamically evaluate expressions, you can unlock deeper insights into your application's performance and operational health. Practice these techniques to enhance your CloudWatch querying skills and make your monitoring efforts more effective.
